---
title: "COVID-19 Risk Modeling"
author: "Duane Edmonds"
output:
  html_document:
    css: custom.css
---

`r format(Sys.time(), '%d %b %Y')`

![](./covid.png)

<style>
body {text-align: justify}
</style>

<br>

# Background

## Open Access Coronavirus Disease Epidemiological Data

### Johns Hopkins University

The Center for Systems Science and Engineering (CSSE) at Johns Hopkins University provides a public, global COVID-19 Github repository (https://github.com/CSSEGISandData/COVID-19) with anonymous patient data aggregated from a number of sources.

>We have built a centralised repository of individual-level information on patients with laboratory-confirmed COVID-19 (in China, confirmed by detection of virus nucleic acid at the City and Provincial Centers for Disease Control and Prevention), including their travel history, location (highest resolution available and corresponding latitude and longitude), symptoms, and reported onset dates, as well as confirmation dates and basic demographics. Information is collated from a variety of sources, including official reports from WHO, Ministries of Health, and Chinese local, provincial, and national health authorities. If additional data are available from reliable online reports, they are included. Data are available openly and are updated on a regular basis (around twice a day).

CSSE Data Sources (partial list):

- World Health Organization (WHO): https://www.who.int
- European Centre for Disease Prevention and Control (ECDC): https://www.ecdc.europa.eu/en/geographical-distribution-2019-ncov-cases
- US CDC: https://www.cdc.gov/coronavirus/2019-ncov/index.html
- DXY.cn. Pneumonia. 2020. http://3g.dxy.cn/newh5/view/pneumonia
- BNO News: https://bnonews.com/index.php/2020/02/the-latest-coronavirus-cases
- WorldoMeters: https://www.worldometers.info/coronavirus
- 1Point3Arces: https://coronavirus.1point3acres.com/en
- COVID Tracking Project: https://covidtracking.com/data

The CSSE data are used for all global analyses in this document.

### The New York Times

The New York Times has also provided public human coronavirus disease case and death data for the United States by county and by state. The U.S. data used for this analysis is pulled directly from The New York Times COVID-19 Github repository (https://github.com/nytimes/covid-19-data).

>The New York Times is releasing a series of data files with cumulative counts of coronavirus cases in the United States, at the state and county level, over time. We are compiling this time series data from state and local governments and health departments in an attempt to provide a complete record of the ongoing outbreak.
>
>Since late January, The Times has tracked cases of coronavirus in real time as they were identified after testing. Because of the widespread shortage of testing, however, the data is necessarily limited in the picture it presents of the outbreak.
>
>We have used this data to power our maps and reporting tracking the outbreak, and it is now being made available to the public in response to requests from researchers, scientists and government officials who would like access to the data to better understand the outbreak.
>
>The data begins with the first reported coronavirus case in Washington State on Jan. 21, 2020. We will publish regular updates to the data in this repository.

<br>

## Data Analysis

The COVID-19 data in the New York Times GitHub repository is structured as three main comma-separated value data files---one top-level country summary file, one state-level summary file, and one data file containing reported case and death data for each individual U.S. county. Each of these is used for this analysis. The data from each of these files is used to calculate the rate of reported new cases and deaths for each state and county, and these rates are used to build a predictive model by linear regression using least-squares methods for each entity. A risk estimate (œÅ) is generated from these models, and the states and counties with the highest estimated risk are compared in the charts shown in this document. In the charts showing new reported cases and deaths, a generalized additive model (GAM) smoothing function was fit to each data set.

The risk assessment methodology used in this analysis has not been validated and is subject to noise in the data. There is a phenomenon that has been reported in the White House press briefings about the COVID-19 response whereby some counties report updates to the county data on Mondays for the incremental changes over the weekend. In fact, cyclical weekly variation can be seen in the reported case and death data. This limits the accuracy of the model to some extent. To enable more robustness to this variation in the estimation of risk, data over a several-day period is used as a compromise between speed of detection of a significant change in the risk estimate and estimation error due to high sensitivity to noise in the data.

The predictive analytics model is built with the open-source [R programming language](https://en.wikipedia.org/wiki/R_(programming_language)) using the [Tidyverse](https://www.tidyverse.org/) family of packages.
 
```{r setup, include = FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  out.width = "100%",
  fig.asp = 0.8,
  fig.align = "center",
  message = FALSE,
  warning = FALSE
)
library(tidyverse)
library(ggthemes)
library(grid)
library(gridExtra)
library(lubridate)
library(RColorBrewer)
library(magrittr)
library(ggsci)
source("../library/ded/ded.R")

prim_color <- pal_jco()(10)[2]
sec_color <- pal_jco()(10)[1]

theme_set(theme_minimal())
```

```{r csse_tidy}
# import data
global_cases <- read_csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv")

global_deaths <- read_csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv")

eu_countries <- read_csv("../library/eu-countries.csv")

# tidy data
#
#   data comes in an untidy format with date columns containing the cumulative number of case or death entries

global_cases <- global_cases %>% 
  pivot_longer(
    cols = 5:ncol(global_cases),
    names_to = "date",
    values_to = "cases"
  ) %>% 
  rename(
    province = `Province/State`,
    country = `Country/Region`,
    latitude = Lat,
    longitude = Long
  ) %>% 
  mutate(
    date = lubridate::mdy(date)
  )

eu_cases <- global_cases %>% 
  filter(country %in% c(eu_countries$Country, "Czechia"))

eu_combined_cases <- eu_cases %>% 
  group_by(date) %>% 
  summarise(cases = sum(cases)) %>% 
  mutate(
    ncases = cases - lag(cases, default = cases[1])
  )
  
```

```{r nytimes_tidy, include = FALSE}
data_path <- "../../../covid-19-data/"

# united states
us <- read_csv(str_glue("{data_path}us.csv"))
us_live <- read_csv(str_glue("{data_path}live/us.csv"))

# states
states <- read_csv(str_glue("{data_path}us-states.csv"))

# counties
counties <- read_csv(str_glue("{data_path}us-counties.csv"))
```

```{r functions, include = FALSE}

# data analysis functions

get_state <- function(state_name) {
  s <- states[states$state == state_name, ] # state object

  s <- s %>%
    mutate(
      ncases = cases - lag(cases, default = cases[1]),
      ndeaths = deaths - lag(deaths, default = deaths[1])
    )

  s
}

get_county <- function(county_name, state_name) {
  c <- counties %>%
    filter(county == county_name, state == state_name) # county object

  if (nrow(c) > 1) {
    c <- c %>%
      mutate(
        ncases = cases - lag(cases, default = cases[1]),
        ndeaths = deaths - lag(deaths, default = deaths[1])
      )
  }

  c
}

covid <- function(state_name = "United States") {
  if (state_name == "United States") {
    s <- us
  }
  else {
    s <- get_state(state_name)
  }

  # output stats
  print(str_glue("{state_name} has {format(s$cases[nrow(s)], big.mark = ',')} cases ",
                 "({format(s$ncases[nrow(s)], big.mark = ',')} cases per day) and ",
                 "{format(s$deaths[nrow(s)], big.mark = ',')} deaths ",
                 "({format(s$ndeaths[nrow(s)], big.mark = ',')} deaths per day)."
        )
  )

  # display new cases and new deaths
  scale_d <- 7

  p <- ggplot(data = s, mapping = aes(x = date)) +
    geom_smooth(
      aes(y = ndeaths * scale_d),
      se = FALSE,
      color = prim_color,
      method = "gam", formula = y ~ s(x, bs = "cs"), level = 0.9,
      na.rm = TRUE
    ) +
    geom_smooth(
      aes(y = ncases),
      se = FALSE,
      color = sec_color,
      method = "gam", formula = y ~ s(x, bs = "cs"), level = 0.9,
      na.rm = TRUE
    ) +
    geom_point(
      aes(y = ndeaths * scale_d, color = sec_color),  # unclear why color reversal is required
      size = 1.5, na.rm = TRUE, alpha = 0.8
    ) +
    geom_point(
      aes(y = ncases, color = prim_color),  # unclear why color reversal is required
      size = 1.5, na.rm = TRUE, alpha = 0.8
    ) +
    labs(
      title = state_name,
      x = "",
      y = "cases (change)",
      color = ""
    ) +
    scale_y_continuous(
      labels = scales::comma,
      sec.axis = sec_axis(~ . / scale_d,
                          name = "deaths (change)",
                          labels = scales::comma
                 )
    ) +
    coord_cartesian(xlim = as.Date(c("2020-03-01",
                                     Sys.Date()
                                     ),
                                   origin = "1960-10-01"
                           ),
                    ylim = c(0, max(s$ncases))
    ) +
    scale_color_manual(
      labels = c("deaths", "cases"),
      values = c(prim_color, sec_color),
      guide = FALSE
    ) +
    theme(
      #axis.text.y = element_text(color = sec_color),
      axis.title.y = element_text(color = sec_color),
      #axis.text.y.right = element_text(color = prim_color),
      axis.title.y.right = element_text(color = prim_color)
    )

  p
}

covidc <- function(county_state) {
  county_name <- str_trim(str_split_fixed(county_state, ",", n = 2)[1])
  state_name <- str_trim(str_split_fixed(county_state, ",", n = 2)[2])


  c <- get_county(county_name, state_name)

  # output stats
  print(str_glue("{county_name} County, {state_name} has ",
                 "{format(c$cases[nrow(c)], big.mark = ',')} cases ",
                 "({format(c$ncases[nrow(c)], big.mark = ',')} cases per day) and ",
                 "{format(c$deaths[nrow(c)], big.mark = ',')} deaths ",
                 "({format(c$ndeaths[nrow(c)], big.mark = ',')} deaths per day)."
        )
  )

  # display new cases and new deaths
  scale_d <- 7

  p <- ggplot(data = c, mapping = aes(x = date)) +
    geom_smooth(
      aes(y = ndeaths * scale_d),
      se = FALSE,
      color = prim_color,
      method = "gam", formula = y ~ s(x, bs = "cs"), level = 0.9,
      na.rm = TRUE
    ) +
    geom_smooth(
      aes(y = ncases),
      se = FALSE,
      color = sec_color,
      method = "gam", formula = y ~ s(x, bs = "cs"), level = 0.9,
      na.rm = TRUE
    ) +
    geom_point(
      aes(y = ndeaths * scale_d, color = sec_color),  # unclear why color reversal is required
      size = 1.5, na.rm = TRUE, alpha = 0.8
    ) +
    geom_point(
      aes(y = ncases, color = prim_color),  # unclear why color reversal is required
      size = 1.5, na.rm = TRUE, alpha = 0.8
    ) +
    labs(
      title = str_glue("{county_name} County, {state_name}"),
      x = "",
      y = "cases (change)",
      color = ""
    ) +
    scale_x_date(limits = as.Date(c("2020-03-01",
                                    Sys.Date()
                                    ),
                                  origin = "1960-10-01"
                          )
    ) +
    scale_y_continuous(
      labels = scales::comma,
      sec.axis = sec_axis(~ . / scale_d,
                          name = "deaths (change)",
                          labels = scales::comma
                 )
    ) +
    coord_cartesian(xlim = as.Date(c("2020-03-01",
                                     Sys.Date()
                                     ),
                                   origin = "1960-10-01"
                           ),
                    ylim = c(0, max(c$ncases))
    ) +
    scale_color_manual(
      labels = c("deaths", "cases"),
      values = c(prim_color, sec_color),
      guide = FALSE
    ) +
    theme(
      #axis.text.y = element_text(color = sec_color),
      axis.title.y = element_text(color = sec_color),
      #axis.text.y.right = element_text(color = prim_color),
      axis.title.y.right = element_text(color = prim_color)
    )
    
  p
}

covid_total <- function(state_name = "United States") {
  if (state_name == "United States") {
    s <- us
  }
  else {
    s <- get_state(state_name)
  }

  # display new cases and new deaths
  scale_d <- 7

  p <- ggplot(data = s, mapping = aes(x = date)) +
    geom_area(
      aes(y = cases, fill = prim_color),
      na.rm = TRUE,
      alpha = 0.8
    ) +
    geom_area(
      aes(y = deaths * scale_d, fill = sec_color),
      na.rm = TRUE,
      alpha = 0.9
    ) +
    labs(
      title = state_name,
      x = "",
      y = "cases",
      fill = ""
    ) +
    scale_y_continuous(
      labels = scales::comma,
      sec.axis = sec_axis(~ . / scale_d,
                          name = "deaths",
                          labels = scales::comma
                 )
    ) +
    coord_cartesian(xlim = as.Date(c("2020-03-15",
                                     Sys.Date()
                                     ),
                                   origin = "1960-10-01"
                           ),
                    ylim = c(0, max(s$cases))
    ) +
    scale_fill_manual(
      labels = c("deaths", "cases"),
      values = c(prim_color, sec_color),
      guide = FALSE
    ) +
    theme(
      #axis.text.y = element_text(color = sec_color),
      axis.title.y = element_text(color = sec_color),
      #axis.text.y.right = element_text(color = prim_color),
      axis.title.y.right = element_text(color = prim_color)
    )
    
  p
}

covidc_total <- function(county_state) {
  county_name <- str_trim(str_split_fixed(county_state, ",", n = 2)[1])
  state_name <- str_trim(str_split_fixed(county_state, ",", n = 2)[2])


  c <- get_county(county_name, state_name)

  # display new cases and new deaths
  scale_d <- 7

  p <- ggplot(data = c, mapping = aes(x = date)) +
   geom_area(
      aes(y = cases, fill = prim_color),
      na.rm = TRUE,
      alpha = 0.8
    ) +
    geom_area(
      aes(y = deaths * scale_d, fill = sec_color),
      na.rm = TRUE,
      alpha = 0.9
    ) +
    labs(
      title = str_glue("{county_name} County, {state_name}"),
      x = "",
      y = "cases",
      fill = ""
    ) +
    scale_x_date(limits = as.Date(c("2020-03-01",
                                    Sys.Date()
                                    ),
                                  origin = "1960-10-01"
                          )
    ) +
    scale_y_continuous(
      labels = scales::comma,
      sec.axis = sec_axis(~ . / scale_d,
                          name = "deaths",
                          labels = scales::comma
                 )
    ) +
    coord_cartesian(xlim = as.Date(c("2020-03-01",
                                     Sys.Date()
                                     ),
                                   origin = "1960-10-01"
                           ),
                    ylim = c(0, max(c$cases))
    ) +
    scale_fill_manual(
      labels = c("deaths", "cases"),
      values = c(prim_color, sec_color),
      guide = FALSE
    ) +
    theme(
      #axis.text.y = element_text(color = sec_color),
      axis.title.y = element_text(color = sec_color),
      #axis.text.y.right = element_text(color = prim_color),
      axis.title.y.right = element_text(color = prim_color)
    )
    
  p
}

calculate_risk_estimate_state <- function(state_name) {
  s <- get_state(state_name)

  # data to be used for fitting linear regression model
  reg_data <- top_n(s, 10, date)

  # linear regression model
  reg_model <- lsfit(reg_data$date, reg_data$ncases)

  return(reg_model$coefficients["X"]) # return slope of ncases rate
}
calculate_risk_estimate_state_c <- compiler::cmpfun(calculate_risk_estimate_state)

calculate_risk_estimate_county <- function(county_name, state_name) {
  c <- get_county(county_name, state_name) # county object

  if (nrow(c) > 20) {
    # data to be used for fitting linear regression model
    reg_data <- top_n(c, 10, date)

    # linear regression model
    reg_model <- lsfit(reg_data$date, reg_data$ncases)

    return(reg_model$coefficients["X"]) # return slope of ncases rate
  }

  return(0)
}
calculate_risk_estimate_county_c <- compiler::cmpfun(calculate_risk_estimate_county)
```

```{r country, include = FALSE}
# u.s. analysis

us <- us %>%
  mutate(
    ncases = cases - lag(cases, default = cases[1]),
    ndeaths = deaths - lag(deaths, default = deaths[1])
  )

p_us_total <- covid_total()
p_us <- covid()
```

```{r states, include = FALSE}
# state analysis

# calculate state risk estimates
state_risk_estimates <- states %>% distinct(state)
state_risk_estimates <- state_risk_estimates %>% # add current risk estimates for all states
  mutate(risk_estimate = map_dbl(state_risk_estimates$state,
                             ~ calculate_risk_estimate_state_c(.)
                     )
  )

state_df <- state_risk_estimates %>% # highest risk estimates
  filter(risk_estimate > 5) %>%
  top_n(15, risk_estimate)
```

```{r counties, include = FALSE}

# calculate county risk estimates
county_risk_estimates <- counties %>%
  filter(county != "Unknown") %>%
  distinct(county, state) %>%
  mutate(state = as.character(state), county = as.character(county))

county_risk_estimates <- county_risk_estimates %>% # add current risk estimates
  mutate(risk_estimate = map2_dbl(county_risk_estimates$county,
                              county_risk_estimates$state,
                              ~ calculate_risk_estimate_county_c(.x, .y)
                     )
  )

county_table <- county_risk_estimates %>% # highest risk estimates
  filter(risk_estimate > 5) %>%
  top_n(15, risk_estimate) %>%
  arrange(desc(risk_estimate)) %>%
  mutate(
    order = as.factor(row_number(risk_estimate)),
    county = as.factor(county),
    state = as.factor(state)
  )
```

<br><br>

---

# Summary Results

### U.S.

```{r country_summary, include = FALSE}
total_us_cases <- us_live$cases[nrow(us_live)]
current_us_ncases <- us$ncases[nrow(us)]
total_us_deaths <- us_live$deaths[nrow(us_live)]
current_us_ndeaths <- us$ndeaths[nrow(us)]
```

There have been `r format( total_us_cases, big.mark="," )` total COVID-19 cases (`r format( current_us_ncases, big.mark="," )` new cases per day) and `r format( total_us_deaths, big.mark="," )` deaths (`r format( current_us_ndeaths, big.mark="," )` new deaths per day) in the United States to date.

<br><br>

```{r country_chart_total}
p_us_total
```

<br><br>

```{r country_chart_change}
p_us
```

<br><br>

### Comparison with the EU

The aggregated data from Johns Hopkins University CSSE was used to calculate a combined case rate for the 27 member states of the European Union (EU). The combined data were used to compare the pandemic response in the EU with the response in the U.S. over time. The rise in infections in the EU preceded the rise in the U.S. For time comparison, the 2500th case recorded in the EU occurred on 02 Mar 2020. The 2500th case in the U.S. was recorded on 14 Mar 2020. This comparison is minimally useful, however, because the populations of the two regions differ (U.S. - 328,239,523; EU - 447,206,135) and there are a number of other factors (e.g., population density, health care systems, prevalence of comorbidities) that are not consistent between the two.

<br>

```{r us_eu_comparison}
eu_color <- "#808080"

us %>% 
  ggplot(mapping = aes(x = date)) +
    # European Union
    geom_smooth(
      data = eu_combined_cases,
      aes(date, ncases),
      se = FALSE,
      color = eu_color,
      method = "gam", formula = y ~ s(x, bs = "cs"), level = 0.9,
      size = 1.0,
      na.rm = TRUE,
      show.legend = FALSE
    ) +
    geom_point(
      data = eu_combined_cases,
      aes(date, ncases),
      color = eu_color,
      size = 1.3, na.rm = TRUE, alpha = 0.8,
      show.legend = FALSE
    ) +
    annotate(
      geom = "text",
      label = "European Union",
      x = as.Date("2020-06-16"),
      y = 8600,
      color = eu_color,
      size = 4.5
    ) +
    # United States
    geom_smooth(
      aes(y = ncases),
      se = FALSE,
      color = sec_color,
      method = "gam", formula = y ~ s(x, bs = "cs"), level = 0.9,
      size = 1.2,
      na.rm = TRUE,
      show.legend = FALSE
    ) +
    geom_point(
      aes(y = ncases, color = sec_color),
      color = sec_color,
      size = 1.5, na.rm = TRUE, alpha = 0.8,
      show.legend = FALSE
    ) +
    annotate(
      geom = "text",
      label = "United States",
      x = as.Date("2020-06-10"),
      y = 37500,
      color = sec_color,
      size = 4.5
    ) +
    labs(
      title = "COVID-19 Case Rates:  United States and European Union",
      x = "",
      y = "cases (change)",
      color = ""
    ) +
    scale_y_continuous(
      labels = scales::comma
    ) +
    coord_cartesian(xlim = as.Date(c("2020-03-01",
                                     Sys.Date()
                                     ),
                                   origin = "1960-10-01"
                           )
    )

```

<br>

---

<br>

### Individual States

```{r state_estimates}
alarm <- 25
state_df %>%
  ggplot(
    aes(x = reorder(state, risk_estimate), y = risk_estimate)) +
    geom_hline(yintercept = alarm,
               size = 0.5,
               color = "darkgrey",
               linetype = "dashed"
    ) +
    geom_bar(
      aes(fill = risk_estimate < alarm),
      stat = "identity",
      width = 0.8,
      alpha = 0.8,
      show.legend = FALSE
    ) +
    coord_flip() +
    labs(
      title = "States with Highest Estimated Risk",
      x = "",
      y = expression(rho),
      fill = ""
    ) +
    scale_fill_manual(values = c(prim_color, sec_color))
```

```{r state_charts, include = FALSE}
p1 <- covid("Florida")
p2 <- covid("California")
p3 <- covid("Texas")
p4 <- covid("Arizona")
p5 <- covid("Louisiana")
p6 <- covid("Georgia")
```

<br><br>

```{r disp_state_charts, fig.asp=1.3}
grid.arrange(p1, p2, p3, p4, p5, p6, nrow = 3)
```

<br>

---

<br>

### Counties

```{r county_estimates}
base_palette_len <- 10
get_palette <- colorRampPalette(pal_jco()(base_palette_len))

n_states <- n_distinct(county_table$state)
palette_len <- ifelse(n_states > base_palette_len, n_states, base_palette_len)

county_table %>%
  mutate(county = fct_reorder(county, risk_estimate)) %>%
  ggplot(aes(x = order, y = risk_estimate)) +
    geom_bar(
      aes(fill = fct_reorder2(state, county, risk_estimate)),
      stat = "identity",
      width = 0.8,
      alpha = 0.8
    ) +
    scale_x_discrete(labels = rev(county_table$county)) +
    scale_fill_manual(values = get_palette(palette_len)) +
    labs(
      title = "Counties with Highest Estimated Risk",
      x = "",
      y = expression(rho),
      fill = "state"
    ) +
    coord_flip()
```

<br><br><br>

---

<br>

# Community Mobility Data

For the purpose of assisting the global COVID-19 pandemic response, Google has made available detailed mobility estimates relative to local baselines obtained from mobile phone and other data of the type used by traffic, etc., services like Google Maps and Waze. The data are provided by Google in the form of [Community Mobility Reports](https://www.google.com/covid19/mobility/).

>As global communities respond to COVID-19, we've heard from public health officials that the same type of aggregated, anonymized insights we use in products such as Google Maps could be helpful as they make critical decisions to combat COVID-19.
>
>These Community Mobility Reports aim to provide insights into what has changed in response to policies aimed at combating COVID-19. The reports chart movement trends over time by geography, across different categories of places such as retail and recreation, groceries and pharmacies, parks, transit stations, workplaces, and residential.

```{r mobility_import, include = FALSE}

community_mobility <- readr::read_csv("./global-mobility-data/Global_Mobility_Report.csv", guess_max = 1e6)  # global mobility data

community_mobility <- community_mobility %>%
  mutate(date = as.Date(date))

```

The data used for the analysis below is current through `r format(max(community_mobility$date), '%d %b %Y')`.

<br>

```{r community_mobility}
regions <- readr::read_csv("../library/regions.csv")

df_highlights <- community_mobility %>%
  filter(
    is.na(sub_region_1),
    is.na(sub_region_2),
    country_region %in% c(
                          "United States",
                          "Canada",
                          "Italy",
                          "Spain",
                          "United Kingdom",
                          "France",
                          "Sweden"
                          )
  ) %>%
  rename(country = country_region)

p <- community_mobility %>%
  left_join(regions, by = c("country_region" = "country")) %>%
  filter(
    is.na(sub_region_1),
    is.na(sub_region_2),
    continent %in% c(
                     "Europe",
                     "North America"
                     )
  ) %>%
  rename(country = country_region) %>%
  ggplot(aes(date, retail_and_recreation_percent_change_from_baseline, group = country)) +
    geom_hline(
      yintercept = 0,
      color = "grey",
    ) +
    geom_smooth(
      color = "#dddddd",
      se = FALSE,
      method = "gam", formula = y ~ s(x, bs = "cs"), level = 0.9,
      size = 0.5
    ) +
    geom_smooth(
      data = df_highlights,
      aes(
        date, retail_and_recreation_percent_change_from_baseline,
        color = fct_reorder(country, desc(retail_and_recreation_percent_change_from_baseline))
      ),
      se = FALSE,
      method = "gam", formula = y ~ s(x, bs = "cs"), level = 0.9,
      size = 1.2
    ) +
    scale_y_continuous(labels = scales::label_percent(scale = 1)) +
    labs(
      title = "Community Mobility - North America and Europe",
      subtitle = "retail and recreation",
      x = "",
      y = "change from baseline",
      color = "country"
    ) +
    ggsci::scale_color_jco()

#plotly::ggplotly(p, tooltip = "country")
p

```

---

<br>

### U.S.

<br>

```{r us_mobility}

# United States
us_mobility <- community_mobility %>%  # u.s. mobility data
  filter(
    country_region_code == "US"
  ) %>%
  rename(
    country = country_region,  # country
    state = sub_region_1,  # state
    cnty = sub_region_2  # county
  ) %>%
  select(
    -country_region_code,
    -(iso_3166_2_code:census_fips_code)
  )

us_mobility_pivot <- us_mobility %>%
  setNames(gsub("_percent_change_from_baseline", "", names(.))) %>%
  pivot_longer(cols = retail_and_recreation:residential, names_to = "activity_category", values_to = "change_from_baseline")


us_mobility_pivot %>%
  filter(
    is.na(state),
    is.na(cnty),
    activity_category %in% c(
                             "retail_and_recreation",
                             "parks",
                             "residential",
                             "transit_stations"
                             )
  ) %>%  # u.s. country-level data
  ded_recode(
    activity_category,
    "retail and recreation=retail_and_recreation",
    "transit stations=transit_stations"
  ) %>% 
  ggplot(aes(date, change_from_baseline, group = activity_category)) +
    geom_hline(
      yintercept = 0,
      color = "grey",
    ) +
    geom_vline(
      xintercept = as.Date("2020-03-13"),
      color = "grey",
      size = 1,
      linetype = "dotted"
    ) + # u.s. declares national emergency
    geom_smooth(
      aes(color = activity_category),
      se = FALSE,
      method = "gam", formula = y ~ s(x, bs = "cs"), level = 0.9,
      size = 1.2
    ) +
    coord_cartesian(
      xlim = as.Date(c("2020-03-13", NA))
    ) +
    scale_y_continuous(labels = scales::label_percent(scale = 1)) +
    labs(
      title = "Community Mobility - United States",
      x = "", y = "change from baseline",
      color = "activity"
    ) +
    scale_color_jco()

```

**Note:**  The dotted grey line on each of the mobility charts represents the 13 Mar 2020 date on which the U.S. declared a [National Emergency Concerning the Novel Coronavirus Disease (COVID-19) Outbreak](https://www.whitehouse.gov/presidential-actions/proclamation-declaring-national-emergency-concerning-novel-coronavirus-disease-covid-19-outbreak/).

<br>

---

<br>

### Individual States

<br>

```{r state_mobility}
us_mobility_pivot %>%
  filter(
    is.na(cnty),
    activity_category %in% c(
                             "retail_and_recreation",
                             "transit_stations"
                             ),
    state %in% c(
                 "California",
                 "Texas",
                 "Arizona",
                 "Florida",
                 "Oklahoma",
                 "South Carolina",
                 "New York",
                 "District of Columbia"
                 )
  ) %>%
  ded_recode(
    activity_category,
    "retail and recreation=retail_and_recreation",
    "transit stations=transit_stations"
  ) %>% 
  ggplot(aes(date, change_from_baseline, color = state)) +
    geom_hline(
      yintercept = 0,
      color = "grey",
    ) +
    geom_vline(
      xintercept = as.Date("2020-03-13"),
      color = "grey",
      size = 1,
      linetype = "dotted"
    ) + # u.s. declares national emergency
    geom_smooth(
      se = FALSE,
      method = "gam", formula = y ~ s(x, bs = "cs"), level = 0.9,
      size = 1.2
    ) +
    coord_cartesian(
      xlim = as.Date(c("2020-03-13", NA)),
      ylim = c(-75, 10)
    ) +
    facet_grid(. ~ activity_category) +
    labs(
      title = "Community Mobility - States",
      x = "", y = "change from baseline (%)",
      color = "state"
    ) +
    scale_color_jco()

```

<br><br><br>

---

<br>

### Data Abnormalities

Analysis of the New York Times United States reported death data reveals a repeating weekly pattern in which the updates on Sunday and Monday are consistently lower than those reported on the other days of the week. As mentioned in the data analysis description in the Background section, the risk estimation algorithm has been configured to reduce the effect of this variation on the statistical model.

<br>

```{r day_of_week, out.width = "65%"}
us %>% 
  mutate(day = wday(date, label = TRUE)) %>% 
  group_by(day) %>% 
  summarise(
    mean_ncases = mean(ncases),
    mean_ndeaths = mean(ndeaths),
    .groups = "drop"
  ) %>% 
  ggplot(aes(day, mean_ndeaths)) +
    geom_col(
      fill = sec_color,
      alpha = 0.8
    ) +
    labs(
      title = "Average Number of Reported Deaths by Day of the Week",
      x = "day of week reported",
      y = "mean of reported deaths"
    ) +
    scale_y_continuous(labels = scales::comma)

```

```{r, include = FALSE}
beepr::beep(2)
```
